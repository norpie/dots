#!/usr/bin/env bash
#
# G-Wolves mouse battery status for waybar/statusbar
# Uses compiled C helper for permissions and speed
#

# Try to use the C binary if available (faster, no Python dependency)
if command -v gwolves-battery-query &> /dev/null; then
    result=$(gwolves-battery-query 2>/dev/null)
    if [ $? -eq 0 ]; then
        IFS='|' read -r capacity charging <<< "$result"

        if [[ "$charging" == "1" ]]; then
            echo "󰍿 $capacity%"
        else
            echo "󰍽 $capacity%"
        fi
        exit 0
    fi
fi

# Fallback: check if battery exists in sysfs (if kernel module is loaded)
batteries=$(find /sys/class/power_supply/ -mindepth 1 -maxdepth 1 -name "*gwolves*" -o -name "hidpp_battery*" 2>/dev/null)

if [[ -n "$batteries" ]]; then
    battery=$(echo $batteries | tail -n 1)
    capacity=$(cat $battery/capacity 2>/dev/null)
    batterystatus=$(cat $battery/status 2>/dev/null)

    if [[ -n "$capacity" ]]; then
        if [[ $batterystatus == "Discharging" ]]; then
            echo "󰍽 $capacity%"
        elif [[ $batterystatus == "Charging" ]]; then
            echo "󰍿 $capacity%"
        else
            echo "󰍾 $capacity%"
        fi
        exit 0
    fi
fi

# No battery found
echo ""
exit 1
