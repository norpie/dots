#!/usr/bin/env bash

# File to store long-running session names
LONG_RUNNING_FILE="$HOME/.config/tmux/long-running-sessions"

# List all existing sessions, filtering out AI sessions
all_sessions=$(tmux ls 2>/dev/null | cut -d: -f1 | grep -v "^__ai_.*__$")

# Filter out long-running sessions
sessions=""
for session in $all_sessions; do
    # Check if session is in long-running list
    if [[ -f "$LONG_RUNNING_FILE" ]] && grep -q "^$session$" "$LONG_RUNNING_FILE"; then
        continue  # Skip long-running sessions
    fi
    sessions+="$session"$'\n'
done

# Remove trailing newline
sessions=$(echo -n "$sessions")

# Use fzf to select or enter a session name and capture the output
output=$(echo "$sessions" | fzf --query="$1" --preview "tmux capture-pane -e -p -t '{}:' | tail -n39" --prompt="Select or create session: " --print-query)

if [ -z "$output" ]; then
    echo "No session selected or entered."
    exit 1
fi

echo "output: $output"

# Read the output into two variables: query and selected
query=$(echo "$output" | sed -n '1p')
selected=$(echo "$output" | sed -n '2p')

echo "query: $query"
echo "selected: $selected"

# If no session was selected, use the query as the new session name
if [ -z "$selected" ]; then
    selected="$query"
fi

# Check if the session exists
tmux has-session -t "$selected" >/dev/null 2>&1

if [[ $? -ne 0 ]]; then
    # If the session does not exist, create it
    tmux new-session -d -s "$selected"
    echo "Created new session: $selected"
fi

# Check if we're inside tmux or not and use appropriate command
if [ -n "$TMUX" ]; then
    # Inside tmux - switch client
    tmux switch-client -t "$selected"
else
    # Outside tmux - attach to session
    tmux a -t "$selected"
fi
